import os
from dotenv import load_dotenv
from crewai import Agent, Task, LLM
from textwrap import dedent

load_dotenv()
meal_planner_agent = Agent(
    role='ุฎุจูุฑ ุชุบุฐูุฉ ููุฎุทุท ูุฌุจุงุช',
    goal=dedent("""
        ุชูููุฏ ุฎุทุท ูุฌุจุงุช ุตุญูุฉ ููุฎุตุตุฉ ูููุณุชุฎุฏููู ุงูุนุฑุจุ ูุน ูุฑุงุนุงุฉ
        ุฃูุฏุงููู ุงูุตุญูุฉุ ุชูุถููุงุชูู ุงูุบุฐุงุฆูุฉุ ูุญุงูุชูู ุงูุทุจูุฉ ูุงูุญุณุงุณูุงุช.
    """),
    backstory=dedent("""
        ุฃูุช ุฎุจูุฑ ุชุบุฐูุฉ ูุนุชูุฏ ููุฏูู ุณููุงุช ูู ุงูุฎุจุฑุฉ ูู ุชุตููู ุฎุทุท ูุฌุจุงุช
        ูุบุฐูุฉ ููุฐูุฐุฉ ุชุณุงุนุฏ ุงูุฃูุฑุงุฏ ุนูู ุชุญููู ุฃูุฏุงููู ุงูุตุญูุฉุ ุณูุงุก ูุงู ุฐูู
        ูููุฏุงู ุงููุฒูุ ุฒูุงุฏุฉ ุงููุฒูุ ุฃู ุงูุญูุงุธ ุนููู. ุชุชููุฒ ุจูุฏุฑุชู ุนูู
        ุชุฎุตูุต ุงูุฎุทุท ูุชูุงุณุจ ุงูุงุญุชูุงุฌุงุช ุงููุฑุฏูุฉุ ุจูุง ูู ุฐูู ุฃููุงุน ุงูุญููุฉ
        ุงููุฎุชููุฉ ูุงูุญุณุงุณูุงุช ุงูุบุฐุงุฆูุฉ ูุงูุญุงูุงุช ุงูุทุจูุฉ.
    """),
    verbose=True,
    allow_delegation=False,
    llm=LLM(
        model="gemini/gemini-2.0-flash",
        api_key=os.getenv("GEMINI_API_KEY"),
        temperature=0
    )
)

def prepare_inputs(user_data):
    """
    ูุญุถุฑ ุงููุฏุฎูุงุช ููููู ูุฎุทุท ุงููุฌุจุงุช.
    """
    return {
        "name": user_data.get("name", "ุงูุฒุงุฆุฑ"),
        "weight": user_data.get("weight"),
        "height": user_data.get("height"),
        "age": user_data.get("age"),
        "sex": user_data.get("sex"),
        "activity_level": user_data.get("activity_level"),
        "goal": user_data.get("goal"),
        "diet_type": user_data.get("diet_type"),
        "allergy": user_data.get("allergy"),
        "conditions": user_data.get("conditions")
    }

generate_meal_plan_task = Task(
    description=dedent("""
        ุจูุงุกู ุนูู ูุนูููุงุช ุงููุณุชุฎุฏู ุงูุชุงููุฉ:
        ุงูุงุณู: {name}
        ุงููุฒู: {weight} ูุฌู
        ุงูุทูู: {height} ุณู
        ุงูุนูุฑ: {age} ุณูุฉ
        ุงูุฌูุณ: {sex}
        ูุณุชูู ุงููุดุงุท: {activity_level}
        ุงููุฏู: {goal}
        ููุน ุงููุธุงู ุงูุบุฐุงุฆู: {diet_type}
        ุงูุญุณุงุณูุงุช ุงูุบุฐุงุฆูุฉ: {allergy}
        ุงูุญุงูุงุช ุงูุทุจูุฉ: {conditions}

        โ ูููุชู:
        - ุชูููุฏ ุฎุทุฉ ูุฌุจุงุช ููููุฉ ููุตูุฉ (ูุทูุฑุ ุบุฏุงุกุ ุนุดุงุกุ ุณูุงูุณุ ุชุญููุฉ ุงุฎุชูุงุฑูุฉ).
        - ูุฌุจ ุฃู ุชููู ุงูุฎุทุฉ ูุงุจูุฉ ููุชุทุจูู ููุงูุนูุฉ ูููุงุณุจุฉ ููุบุฉ ุงูุนุฑุจูุฉ ุงููุตุญู ุงููุจุณุทุฉ.
        - ุชุฃูุฏ ูู ูุฑุงุนุงุฉ ุฌููุน ุชูุงุตูู ุงููุณุชุฎุฏู (ุงููุฏูุ ุงูุญุณุงุณูุงุชุ ุงูุญุงูุงุช ุงูุทุจูุฉุ ููุน ุงููุธุงู ุงูุบุฐุงุฆู).
        - ูู ุจุชุถููู ุฅุฌูุงูู ุงูุณุนุฑุงุช ุงูุญุฑุงุฑูุฉ ุงูุชูุฑูุจู ููุฎุทุฉ ุจุฃููููุง ูู ุงูููุงูุฉ (ุนูู ุณุจูู ุงููุซุงู: "ุฅุฌูุงูู ุงูุณุนุฑุงุช ุงูุญุฑุงุฑูุฉ ุงูุชูุฑูุจู ููุฎุทุฉ: 1800-2000 ุณุนุฑุฉ ุญุฑุงุฑูุฉ").

        โ ููุงุญุธุงุช ูููุฉ ุฌุฏุงู:
        - **ูุง ุชุณุชุฎุฏู ุฃู ุชูุณููุงุช Markdown (ูุซู **ูุต ุณููู**ุ *ูุต ูุงุฆู*ุ #ุนูุงููู#ุ -ููุงุฆู-) ูู ุฌุณู ุฎุทุฉ ุงููุฌุจุงุช. ุงุณุชุฎุฏู ูุตูุง ุนุงุฏููุง ููุจุงุดุฑูุง.**
        - ุงุณุชุฎุฏู ุฑููุฒ ุชุนุจูุฑูุฉ (ุฅูููุฌู) ุจุณูุทุฉ ูุซู ๐ณ๐ฝ๏ธ๐ฅฃ๐ฅ๐ ูุชุญุฏูุฏ ุฃูุณุงู ุงููุฌุจุงุช ุจุฏูุงู ูู ุงูุชูุณูู ุจุงููุต ุงูุณููู.
        - ุงุณุชุฎุฏู ููุงุตู ุงูุฃุณุทุฑ (enter) ูุชูุธูู ุงููุต ูุฌุนูู ุณูู ุงููุฑุงุกุฉ.
        - ูุง ุชูุฑุฌุน ุงูุฅุฎุฑุงุฌ ุจุชูุณูู JSON.
        - ูุง ุชุจุฏุฃ ุจู "ูุง ูู ุงููุงุชุฌ"ุ ููุท ุงููุต ุงูููุงุฆู ูุฎุทุฉ ุงููุฌุจุงุช.

        โ ูุซุงู ููุชูุณูู ุงููุทููุจ (ุจุฏูู ุฃู ุนูุงูุงุช Markdown):

        ---
        ๐ณ ุงููุทูุฑ:
        - ุจูุถุชุงู ูุณูููุชุงู
        - ุดุฑูุญุฉ ุฎุจุฒ ุฃุณูุฑ
        - ูุตู ููุจ ุดููุงู ูุน ุญููุจ ุงูููุฒ ูุฑุดุฉ ูุฑูุฉ
        - ุซูุฑุฉ ูุงููุฉ (ูุซู ุงูุชูุงุญ ุฃู ุงูููุซุฑู)

        ๐ฝ๏ธ ุงูุบุฏุงุก:
        - ุตุฏุฑ ุฏุฌุงุฌ ูุดูู (150 ุฌู) ูุชุจู ุจุงูุฃุนุดุงุจ
        - ุทุจู ุณูุทุฉ ุฎุถุฑุงุก ูุจูุฑ ูุน ุฒูุช ุฒูุชูู ูุฎู
        - 4 ููุงุนู ุฃุฑุฒ ุจูู

        ๐ฅฃ ุงูุนุดุงุก:
        - ุณูู ูุดูู (150 ุฌู)
        - ุทุจู ุฎุถุงุฑ ูุดููุฉ (ูุซู ุงูููุณุฉ ูุงูุฌุฒุฑ ูุงูุจุฑูููู)
        - ุจุทุงุทุง ูุดููุฉ ุตุบูุฑุฉ

        ๐ฅ ุณูุงูุณ:
        - ุญููุฉ ููุณุฑุงุช ุบูุฑ ูููุญุฉ (ุงูููุฒ ุฃู ุงูุฌูุฒ)
        - ุฎูุงุฑ ุฃู ุฌุฒุฑ ููุทุน
        - ุฒุจุงุฏู ุฌูุฒ ุงูููุฏ ูููู ุงูุฏุณู

        ๐ ุชุญููุฉ:
        - ูุทุนุฉ ุตุบูุฑุฉ ูู ุงููุงููุฉ ุงูุทุงุฒุฌุฉ (ูุซุงู: ุจุฑุชูุงูุฉ)

        ุฅุฌูุงูู ุงูุณุนุฑุงุช ุงูุญุฑุงุฑูุฉ ุงูุชูุฑูุจู ููุฎุทุฉ: 1800-2000 ุณุนุฑุฉ ุญุฑุงุฑูุฉ
        ---
    """),
    agent=meal_planner_agent,
    expected_output="str",
    async_execution=False
)
